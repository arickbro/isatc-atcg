<!DOCTYPE html>
<html lang="en">
<head>
  <title>IsatC Batam</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.49/css/bootstrap-datetimepicker.min.css" integrity="sha512-ipfmbgqfdejR27dWn02UftaAzUfxJ3HR4BDQYuITYSj6ZQfGT1NulP4BOery3w/dT2PYAe3bG5Zm/owm7MuFhA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


	<style>
		#signalLevel{
			float:right;
		}
		
		#modal__content{
			height: 500px;
    overflow-y: scroll;
		}
	</style>
</head>
<body>

<div class="container">


<ul class="nav nav-tabs">
  <li id="tab__info"class="active"><a data-toggle="tab" href="#home"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Device Info</a></li>
  <li id="tab__status" ><a data-toggle="tab" href="#dev_status"><span class="glyphicon glyphicon-random" aria-hidden="true"></span> Status</a></li>
  <li id="tab__egc" ><a data-toggle="tab" href="#dev_egc"><span class="glyphicon glyphicon-book" aria-hidden="true"></span> EGC</a></li>
  <li id="tab__dir" ><a data-toggle="tab" href="#dev_dir"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> Directory</a></li>
  <li><a data-toggle="tab" href="#send_email"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send Email</a></li>
  <li><a data-toggle="tab" href="#send_data"><span class="glyphicon glyphicon-send" aria-hidden="true"></span> Send Data</a></li>
  <li><a data-toggle="tab" href="#send_cmd"><span class="glyphicon glyphicon-console" aria-hidden="true"></span> Command</a></li>
  <li id="tab__config"><a data-toggle="tab" href="#config" ><span class="glyphicon glyphicon-cog" aria-hidden="true"></span> Config</a></li>
  <li id="signalLevel"><a><span class="glyphicon glyphicon-signal" aria-hidden="true"></span>&nbsp;&nbsp; <span id="snr"></span></a></li>
</ul>

<div class="tab-content">
  <div id="home" class="tab-pane fade in active">
    <h3>Device Info</h3>
 <dl class="dl-horizontal" id="data__info"> 
 </dl>
 
 

  </div>
  <div id="dev_status" class="tab-pane fade">
    <h3>Device Status</h3>
 <dl class="dl-horizontal" id="data__status"> 
 </dl>
	
	
  </div>

    <div id="dev_egc" class="tab-pane fade">
    <h3>EGC Messages</h3>
	<div class="form-inline">
  <div class="form-group">
  <div class="col-sm-12">
	<input type="text" id="egc_start" class="form-control">
	 </div>
	 </div>
	 <div class="form-group">
	 <div class="col-sm-12">
	<input type="text" class="form-control" id="egc_end">
	 </div>
	  </div>
	   <div class="form-group">
	<input type="text" value="5" id="egc_limit" class="form-control">
	</div>
	 <div class="form-group">
	<input type="text" value="0" id="egc_offset" class="form-control">
	</div>
	 <div class="form-group">
	<button id="fetch_egc">Submit</button>
	</div>
	    </div>
  <div id="table__egc" >  </div>

  </div>
  
  
      <div id="dev_dir" class="tab-pane fade">
    <h3>Device Directory</h3>
	<input type="text" value="0" id="dir_start">
	<input type="text" value="100000000000" id="dir_end">
	<input type="text" value="5" id="dir_limit">
	<input type="text" value="0" id="dir_offset">
	<button id="fetch_dir">Submit</button>
  <div id="table__dir" >  </div>

  </div>
  
  	  <div id="send_email" class="tab-pane fade">
    <h3>Send Email</h3> 
  
       <form id="formTopic" name="formTopic">

  <div class="form-group">
    <label for="inputPassword" class=" col-form-label">Email Dest</label>
    <div class="">
		<input type="email"  class="form-control form-control-sm"  name="dest" id="dest">
		
    </div>
  </div>
  
  <div class="form-group">
    <label for="inputPassword" class=" col-form-label">Subject</label>
    <div class="">
		<input type="text"  class="form-control form-control-sm"  name="subject" id="subject">
		
    </div>
  </div>
  
  
    <div class="form-group">
    <label for="inputPassword" class=" col-form-label">Body</label>
    <div class="">
		<textarea type="text"  class="form-control form-control-sm"  name="body" id="body"></textarea>
		
    </div>
  </div>
  
      <div class="form-group ">

      <button type="submit"  id="fetchTopic" class="btn">Send</button>
  </div>
  

</form>

 </div>
  		  <div id="send_cmd" class="tab-pane fade">
    <h3></h3>  
     <form id="formCMD" name="formCMD">

  <div class="form-group">
    <label for="inputPassword" class=" col-form-label">Command</label>
    <div class="">
		<input type="text"  class="form-control form-control-sm"  name="cmd" id="cmd">
		
    </div>
  </div>
  

  
      <div class="form-group ">

      <button type="submit"  id="sendCmd" class="btn">Send</button>
  </div>
   <div class="form-group">
    <label for="inputPassword" class=" col-form-label">Respond</label>
    <div class="">
		<textarea type="text"  class="form-control form-control-sm"  name="resp" id="resp" rows=15></textarea>
		
    </div>
  </div>

</form>
 </div>
  <div id="config" class="tab-pane fade">
    <h3>Configuration</h3>
	 <form class="form-horizontal" id="config__form" action="somewhere" method="post">
		</form>
	</div>
  <div id="send_data" class="tab-pane fade">
    <h3>Send Data</h3>
 
 
 
 <form class="form-horizontal" id="form__tx">
  <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">les_id</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="les_id" name="les_id"  required=required>
	  <p class="help-block">Specifies which LES to route the message.</p>
    </div>
  </div>
    <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">delivery_service</label>
    <div class="col-sm-10">
      <select class="form-control" id="delivery_service" name="delivery_service">
	  </select>
    </div>
  </div>
  
  
      <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">destination_network</label>
    <div class="col-sm-10">
      <select class="form-control" id="destination_network" name="destination_network">
	  </select>
	   <p class="help-block">Terrestrial link to use.</p>
    </div>
  </div>
    <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">destination_ext</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="destination_ext" name="destination_ext">
	  <p class="help-block">Additional receiver information</p>
    </div>
  </div>
  
  
      <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">language</label>
    <div class="col-sm-10">
       <select class="form-control" id="language" name="language">
	  </select>
	  <p class="help-block">presentation at the receiving end.</p>
    </div>
  </div>
  
       <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">Date and Time</label>
    <div class="col-sm-10">
       <input type="text" class="form-control" id="date_time" name="date_time" placeholder="YY-MM-DD">
	  <p class="help-block">Set transmission date and time.</p>
    </div>
  </div>
  
       <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 control-label">Data</label>
    <div class="col-sm-10">
       <textarea class="form-control" id="content" name="content" ></textarea>
    </div>
  </div>
  
  

  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <div class="checkbox">
        <label>
          <input type="checkbox" name="distress_priority" value="1"> Transmits a message with distress priority.
        </label>
      </div>
	  
	   <div class="checkbox">
        <label>
          <input type="checkbox" name="required_confirmation" value="1"> Request confirmation from the LES on the final delivery from the LES to the destination
        </label>
      </div>
	  
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button type="submit" id="submitTx" class="btn btn-default">Submit</button>
    </div>
  </div>
</form>


  </div>
</div>

</div>


  <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Messages</h4>
      </div>
      <div class="modal-body">
        <pre id="modal__content">
		</pre>
      </div>

    </div>
  </div>
</div>


</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.49/js/bootstrap-datetimepicker.min.js" integrity="sha512-jPwanAeILSRxZLeyP1XYBOo67+how4C1Ij54LQSa8xIOP3hKyeWRe24C0scI4QrTeQywKd1meF4Pak/Glv34vA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>

var mnemonic = {};
mnemonic["delivery_service"] = {"data":{0:"Store-and-forward",1:"Prefixed Store-and-forward"}, "default":0};
mnemonic["destination_network"] = {"data":{0:"Telex",1:"PSTN Use -e(fax or telephone modem)",3:"PSDN(X.25 data network)",5:"Closed network Use destination_ext (DNID's)",6:"Special access code Use destination_ext"}, "default":0};
mnemonic["language"] = {"data":{0:"Int. Alphabet no. 5, odd parity",6:"ITA-2. Packed baudot.",7:"Data"}, "default":0};

var egcMnemonic ={};
egcMnemonic['service'] = {
	0:"General Call",
	2:"Group Call",
	4:"Urgency Message, Nav Warning to Rectangular Area",
	11:"INMARSAT System Message",
	13:"Coastal Warning",
	14:"Distress Alert to Circular area",
	23:"EGC System Message",
	24:"Urgency Message, Nav Warning to Circular Area",
	31:"MET Navarea Warning or MET Forecast",
	33:"Download Group Identity (ENID)",
	34:"SAR Coordination to Rectangular area",
	44:"SAR Coordination to Circular area",
	72:"Chart Correction Service",
	73:"Chart Correction Service for fixed areas"
}

egcMnemonic['priority'] = {
	0:"Routine",
	1:"Safety",
	2:"Urgency",
	3:"Distress"
}

for(field_id in mnemonic){
	var txt ="";
	for (option in mnemonic[field_id]["data"]){
		var val = mnemonic[field_id]["data"][option]
		var isDefault = option == mnemonic[field_id]["default"] ? "selected='selected'":'';
		txt+= "<option value='"+option+"' "+isDefault+">"+val+"</option>"
	}
	$("#"+field_id).html(txt);
}


	 let encodeHtml = str => {
  let buf = [];

  for (var i = str.length - 1; i >= 0; i--) {
    buf.unshift(['&#', str[i].charCodeAt(), ';'].join(''));
  }

  return buf.join('');
}

var mainUrl = '';


function epoch_to_iso(epoch){
	return new Date(parseInt(epoch)*1000).toISOString();
}
function create_table_json(data,tsIndex,fileIndex){

  table = '<table id="table__egc" class="table table-striped table-condensed table-bordered" style="width:100%">'+
        '<thead>'+
            '<tr>';
			
	for(col in data['columns']){
		table += '<th>'+data['columns'][col]+'</th>'
	}		
              
			  
    table +='<td>data</td>  </tr>'+
        '</thead>'+
        '<tbody>'
		
		for(row in data['data']){
		 table +='  <tr>'
		for(td in data['data'][row]){
			var tdVal = data['data'][row][td]
			if(td == tsIndex){
				table += '<td>'+epoch_to_iso(tdVal)+'</td>'
			}else{
				if(data['columns'][td] in egcMnemonic){
					tdVal = egcMnemonic[data['columns'][td]][tdVal];
				}
				table += '<td>'+tdVal+'</td>'
			}
			
		}
		
		table += '<td><a href="#" class="readData" data="'+data['data'][row][tsIndex]+'-'+data['data'][row][fileIndex]+'">read</td>'
		 table +='  </tr>'
		
	}
	
		 table +='</tbody>'+
		
  '</table>'
  
	return table
}


$(document).ready(function() {
	$('#fetch_egc').click( function(e) {
		
		start = moment($('#egc_start').val(), "YYYY-MM-DD HH:mm").unix();
		end = moment($('#egc_end').val(), "YYYY-MM-DD HH:mm").unix();
		limit = $('#egc_limit').val();
		offset = $('#egc_offset').val();
				
				
		$.ajax({
			url: mainUrl+'egc',
			type: 'get',
			dataType: 'json',
			data:  {start:start,end:end,limit:limit,offset:offset},
			success: function(data) {
				$("#table__egc").html(create_table_json(data,4,9))
				
			}
		});
		
	});
	
	$('#fetch_dir').click( function(e) {
		
		start = $('#dir_start').val();
		end = $('#dir_end').val();
		limit = $('#dir_limit').val();
		offset = $('#dir_offset').val();
				
				
		$.ajax({
			url: mainUrl+'directory',
			type: 'get',
			dataType: 'json',
			data:  {start:start,end:end,limit:limit,offset:offset},
			success: function(data) {
				$("#table__dir").html(create_table_json(data,1,0))
				
			}
		});
		
	});
	
	

} );

/* read file content*/
	$( document ).delegate( ".readData", "click",function(e) {
		e.preventDefault();
		var id = $(this).attr("data");
		$.ajax({
			url: mainUrl+'directory/'+id,
			type: 'get',
			dataType: 'json',
			success: function(data) {

				if(data["data"] == null){
					$("#modal__content").html("data no longer exist");
				}else{
					$("#modal__content").html(data["data"][3]);
				}
				$("#myModal").modal("show");
				
			}
		});
		
	});

/* fetch content */
	$('#sendCmd').click( function(e) {
		e.preventDefault();
		$("#sendCmd").html("sending ...");
		$.ajax({
			url: mainUrl+'command',
			type: 'post',
			data: {"cmd":$("#cmd").val()},
			success: function(data) {
				$("#sendCmd").html("Send");
				$("#resp").html(encodeHtml(data.data));
				
			}
		});
		
	});
	

/* read config */	
		$('#tab__config').click( function(e) {
		e.preventDefault();
		$.ajax({
			url: mainUrl+'configuration',
			type: 'get',
			dataType: 'json',
			success: function(data) {
				$("#sendCmd").html("Send");
				var txt =''
				console.log(data);
				for(key in data['data']){
				console.log(key);
				 txt +='<div class="form-group">'+
    '<label for="inputEmail3" class="col-sm-2 control-label">'+key+'</label>'+
    '<div class="col-sm-10">'+
      '<input type="text" class="form-control input-sm" id="config__'+key+'" name="'+key+'"  value="'+data['data'][key]+'">'+
    '</div>'+
  '</div>'
				}
				txt +='<div class="form-group">'+
    '<div class="col-sm-offset-2 col-sm-10">'+
      '<button type="submit" id="submitConfig" class="btn btn-default">Submit</button>'+
    '</div>'+
  '</div>'
				$("#config__form").html(txt);
				
			}
		});
		
	});
	
/* submit config */
$(document).delegate("#submitConfig", "click", function(e) {
	e.preventDefault();
	var fields = $('#config__form').serializeArray();
	
	var body = {}
	for (i in  fields){
		body[fields[i]['name']] = fields[i]['value'];
	}

	console.log(body)
	$.ajax({
		type: "POST",
		dataType: "json",
		data: JSON.stringify(body),
		contentType: "application/json; charset=utf-8",
		url: mainUrl+'configuration',
		success: function(re) {
			console.log(re)
		}
	});
});

/* submit config */
$(document).delegate("#submitTx", "click", function(e) {
	e.preventDefault();
	var fields = $('#form__tx').serializeArray();
	
	var body = {}
	for (i in  fields){
		body[fields[i]['name']] = fields[i]['value'];
	}

	console.log(body)
	$.ajax({
		type: "POST",
		dataType: "json",
		data: JSON.stringify(body),
		contentType: "application/json; charset=utf-8",
		url: mainUrl+'tx',
		success: function(re) {
			console.log(re)
		}
	});
});
	
	
function fetch_device_info(){
	
	$.ajax({
			url: mainUrl+'info',
			type: 'get',
			dataType: 'json',
			success: function(data) {
				$("#sendCmd").html("Send");
				var txt =''
				console.log(data);
				for(key in data['data']){
					txt +='<dt>'+key+'</dt> <dd>'+data['data'][key]+'</dd>'
	
				}
				
				$("#data__info").html(txt);
				
			}
		});
}


			$('#tab__info').click( function(e) {
		e.preventDefault();
	fetch_device_info()
		
	});


			$('#tab__status').click( function(e) {
		e.preventDefault();
		$.ajax({
			url: mainUrl+'status',
			type: 'get',
			dataType: 'json',
			success: function(data) {
				$("#sendCmd").html("Send");
				var txt =''
				console.log(data);
				for(key in data['data']){
					txt +='<dt>'+key+'</dt> <dd>'+data['data'][key]+'</dd>'
	
				}
				
				$("#data__status").html(txt);
				
			}
		});
		
	});
	
	$('#fetchTopic').click( function(e) {
		e.preventDefault();
		$.ajax({
			url: mainUrl+'email',
			type: 'post',
			data: $('#formTopic').serialize(),
			success: function(data) {
				
				alert(data)
				
			}
		});
		
	});
	
	


var myVar = setInterval(myTimer, 10000);

function myTimer() {

	$.ajax({
			url: mainUrl+'snr',
			type: 'get',
			dataType: 'json',
			success: function(data) {
				document.getElementById("snr").innerHTML = data["data"]["signal"];
			}
		});
		
  
}
myTimer();
var seven_days_ago = moment().day(-7);
fetch_device_info();
  $('#egc_start').datetimepicker({
		defaultDate: seven_days_ago,
		format:"YYYY-MM-DD HH:mm",
	});

 $('#egc_end').datetimepicker({
		defaultDate: new Date(),
		format:"YYYY-MM-DD HH:mm"
	});
	
    $('#date_time').datetimepicker({
	format:"YY-MM-DD HH:mm",
	minDate: new Date(),
	});
	
	
</script>